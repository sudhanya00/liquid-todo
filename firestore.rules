rules_version = '2';

// Smera (LiquidTodo) Firestore Security Rules
// Last Updated: December 15, 2025
// 
// Security Principles:
// 1. Zero trust in client-only checks
// 2. Owner-only access for all user data
// 3. Server-side only writes for sensitive data (userPlans)

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the authenticated user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if the resource belongs to the authenticated user
    function isResourceOwner() {
      return isAuthenticated() && request.auth.uid == resource.data.ownerId;
    }
    
    // Check if the new resource will belong to the authenticated user
    function willBeOwner() {
      return isAuthenticated() && request.auth.uid == request.resource.data.ownerId;
    }
    
    // ============================================
    // Spaces Collection
    // ============================================
    
    match /spaces/{spaceId} {
      // Allow read only if user owns the space
      allow read: if isResourceOwner();
      
      // Allow create only if user will be the owner
      allow create: if willBeOwner();
      
      // Allow update/delete only if user owns the space
      allow update, delete: if isResourceOwner();
    }
    
    // ============================================
    // Tasks Collection (Future - Cloud Storage)
    // ============================================
    
    match /spaces/{spaceId}/tasks/{taskId} {
      // Helper to check space ownership
      function ownsParentSpace() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/spaces/$(spaceId)).data.ownerId == request.auth.uid;
      }
      
      // Allow all operations if user owns the parent space
      allow read, write: if ownsParentSpace();
    }
    
    // ============================================
    // User Plans Collection
    // ============================================
    
    match /userPlans/{userId} {
      // Users can read/write their own plan
      allow read, write: if isOwner(userId);
      
      // Note: Server-side API routes use Firebase Admin SDK which bypasses these rules
    }
    
    // ============================================
    // AI Logs Collection (Future - Observability)
    // ============================================
    
    match /aiLogs/{logId} {
      // No client access - server only via Admin SDK
      allow read, write: if false;
    }
    
    // ============================================
    // Default Deny
    // ============================================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
